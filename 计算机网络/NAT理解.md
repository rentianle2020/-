192.168.101.19

掩码255.255.255.0

网关192.168.101.1

**内网访问**

如果访问内网地址192.168.101.2（给我手机分配的内网地址）

通过内网掩码判断，发现是同一个子网下的，直接在路由器（不通过WAN口，只使用LAN口，其实就是交换机功能）的MAC表中，找到对应的MAC地址的机器，发送数据包



**外网访问**

如果访问的地址是14.215.177.38（百度的地址）

通过掩码发现，不是属于同一个子网，则先发送到网关（路由器WAN口）

此时通过路由器SNAT技术，将源IP转换为外网IP 183.11.31.218

通过路由器网关维护的路由表，不断传递，到达百度

返回的数据包到达路由器，路由器反向SNAT，将183.11.31.218转换为192.168.101.19

但如果手机和电脑同时访问百度，返回谁？这时就用到了传输层的端口号，SNAT修改源IP+源端口，映射一台主机。比如192.168.101.19 端口号80修改为2333映射电脑，192.168.101.2端口号80修改为1000映射手机。映射到主机后，最后将端口号改回，让主机找到对应进程，完成通信。



**外网接收**

DNAT目标地址转换，将公网上发送的请求，转发到指定的主机。在路由器上配置DNAT，将访问183.11.31.218:8080端口的请求，转发到192.168.101.19:80（部署在PC的服务器监听的80端口）



**反向SNAT和DNAT**

虽然都是转换目标IP

反向SNAT是正向发送出请求后，同一个进程接收返回数据时执行的

DNAT是在一台服务器上的一个进程主动配置的，每次路由器都会自动的转发给它